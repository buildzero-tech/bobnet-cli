name: Test BobNet Upgrade

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-upgrade:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git
      
      - name: Configure Git
        run: |
          git config --global user.email "ci@bobnet.test"
          git config --global user.name "BobNet CI"
      
      - name: Install OpenClaw (current version)
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
        run: |
          npm install -g "openclaw@$OPENCLAW_CURRENT"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify OpenClaw version
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
        run: |
          openclaw --version
          test "$(openclaw --version)" = "$OPENCLAW_CURRENT"
      
      - name: Install BobNet CLI
        run: |
          ./install.sh --update
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify BobNet CLI
        run: |
          bobnet --version
          which bobnet
      
      - name: Run upgrade test
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
          OPENCLAW_TARGET: ${{ vars.OPENCLAW_TARGET || 'latest' }}
        run: |
          ./test-upgrade-vm.sh --verbose --clean
      
      - name: Verify upgrade succeeded
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
          OPENCLAW_TARGET: ${{ vars.OPENCLAW_TARGET || 'latest' }}
        run: |
          NEW_VERSION=$(openclaw --version)
          echo "Upgraded to: $NEW_VERSION"
          
          # Check version changed
          test "$NEW_VERSION" != "$OPENCLAW_CURRENT"
          
          # If specific target version, verify exact match
          if [ "$OPENCLAW_TARGET" != "latest" ]; then
            test "$NEW_VERSION" = "$OPENCLAW_TARGET"
          fi
      
      - name: Check version tracking
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
        run: |
          cat ~/.bobnet/ultima-thule/config/openclaw-versions.json
          
          # Verify starting version in history
          jq -e --arg ver "$OPENCLAW_CURRENT" \
            '.history[] | select(.version == $ver)' \
            ~/.bobnet/ultima-thule/config/openclaw-versions.json
          
          # Verify at least 2 entries (before + after)
          jq -e '.history | length >= 2' \
            ~/.bobnet/ultima-thule/config/openclaw-versions.json
      
      - name: Validate config
        run: |
          cd ~/.bobnet/ultima-thule
          bobnet validate
      
      - name: Test rollback
        run: |
          ./test-rollback-vm.sh --verbose
      
      - name: Verify rollback succeeded
        env:
          OPENCLAW_CURRENT: ${{ vars.OPENCLAW_CURRENT || '2026.1.30' }}
        run: |
          ROLLED_VERSION=$(openclaw --version)
          echo "Rolled back to: $ROLLED_VERSION"
          
          # Should be back to starting version
          test "$ROLLED_VERSION" = "$OPENCLAW_CURRENT"
