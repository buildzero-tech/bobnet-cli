#!/usr/bin/env bash
# Git commit-msg hook: Validate conventional commit format
#
# Installation:
#   cp hooks/commit-msg .git/hooks/commit-msg
#   chmod +x .git/hooks/commit-msg
#
# Format:
#   type(scope): description #issue
#
# Valid types:
#   feat, fix, docs, test, chore, refactor, perf, style, build, ci
#
# Examples:
#   feat(spec): add bobnet spec create-issues command #36
#   fix(work): handle closed issues in work start #37
#   docs(commands): add CLI reference documentation #42

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits and revert commits
[[ "$COMMIT_MSG" =~ ^Merge ]] && exit 0
[[ "$COMMIT_MSG" =~ ^Revert ]] && exit 0

# Skip if commit message starts with # (comment)
[[ "$COMMIT_MSG" =~ ^\# ]] && exit 0

# Skip if this is a fixup/squash commit
[[ "$COMMIT_MSG" =~ ^(fixup|squash)! ]] && exit 0

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Conventional commit pattern
# Format: type(scope): description
# Optional: #issue at end
PATTERN='^(feat|fix|docs|test|chore|refactor|perf|style|build|ci)(\([a-z0-9-]+\))?: .+'

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo -e "${RED}ERROR: Commit message does not follow conventional commit format${NC}" >&2
    echo "" >&2
    echo "Format: type(scope): description #issue" >&2
    echo "" >&2
    echo "Valid types:" >&2
    echo "  feat     - New feature" >&2
    echo "  fix      - Bug fix" >&2
    echo "  docs     - Documentation" >&2
    echo "  test     - Testing" >&2
    echo "  chore    - Maintenance" >&2
    echo "  refactor - Code refactoring" >&2
    echo "  perf     - Performance" >&2
    echo "  style    - Code style" >&2
    echo "  build    - Build system" >&2
    echo "  ci       - CI/CD" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  feat(spec): add create-issues command #36" >&2
    echo "  fix(work): handle closed issues #37" >&2
    echo "  docs: update README #43" >&2
    echo "" >&2
    echo "Your commit message:" >&2
    echo "  $COMMIT_MSG" >&2
    exit 1
fi

# Warn if no issue reference (optional, not blocking)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
if ! echo "$FIRST_LINE" | grep -qE '#[0-9]+'; then
    echo -e "${YELLOW}WARNING: No issue reference found (e.g., #123)${NC}" >&2
    echo "Consider adding issue reference for tracking" >&2
fi

exit 0
